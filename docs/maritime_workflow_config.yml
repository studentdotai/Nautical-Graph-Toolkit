# ===============================================
# Maritime Workflow Orchestration Configuration
# ===============================================
#
# REQUIRED: Database credentials must be set in .env file:
#   DB_NAME=your_database_name
#   DB_USER=your_database_user
#   DB_PASSWORD=your_database_password
#   DB_HOST=localhost (or your database host)
#   DB_PORT=5432 (default PostgreSQL port)
#
# REQUIRED: Graph configuration loaded from src/nautical_graph_toolkit/data/graph_config.yml
#
# This config defines workflow orchestration parameters:
# - Which pipeline steps to run (base_graph → fine_graph → weighting → pathfinding)
# - Geographic area of interest (departure and arrival ports)
# - Port definitions and precise coordinates for routing
# - Vessel specifications (draft, height, safety margins)
# - Output paths and file naming conventions

# --- Configuration Paths ---
# IMPORTANT: Path is relative to the project root directory
# This file must exist and contain graph generation parameters (H3 resolution, spacing, etc.)
graph_config_path: "src/nautical_graph_toolkit/data/graph_config.yml"

# --- Database Schema Configuration ---
database:
  enc_schema: "enc_west"        # Schema containing S-57 ENC layers
  graph_schema: "graph"           # Schema for saving graph tables
  route_schema: "routes"          # Schema for route storage
  geopackage_filename: "enc_west.gpkg"  # GeoPackage backend: Source ENC data file

# --- Workflow Control ---
# Enable/disable major pipeline steps
workflow:
  run_base_graph: true            # Step 1: Create base 0.3NM resolution graph
  run_fine_graph: true            # Step 2: Create fine/H3 high-resolution graph
  run_weighting: true             # Step 3: Apply weighting system
  run_pathfinding: true           # Step 4: Calculate optimal routes

# ===============================================
# STEP 1: BASE GRAPH CONFIGURATION
# ===============================================
# Creates initial coarse-resolution graph (0.3 NM spacing)
# Used to establish AOI and baseline routing before fine-resolution work

base_graph:
  # Area of Interest (AOI) definition
  # Two ports define the geographic scope; expansion extends the bounding box
  departure_port: "Los Angeles"
  arrival_port: "San Francisco"
  expansion_nm: 24.0              # Expansion of bounding box in nautical miles
                                  # Expands from the ports' bounding box, not port points

  # Graph generation parameters
  layer_table: "seaare"           # Primary navigable layer from S-57
  spacing_nm: 0.3                 # Node spacing in nautical miles
  reduce_distance_nm: 0           # Safety buffer reduction (0 = no reduction)

  # Output naming conventions
  graph_name: "base_graph"        # Table/file name for base graph
  base_route_name: "base_route"   # Route identifier name
  base_routes_table_name: "base_routes"  # Table name in routes GeoPackage (GeoPackage backend)

# ===============================================
# STEP 2: FINE/H3 GRAPH CONFIGURATION
# ===============================================
# Creates high-resolution graph for detailed routing
# Supports two modes: regular grid ("fine") or hexagonal ("h3")

fine_graph:
  # Graph resolution mode and naming
  # NOTE: Graph table names are automatically constructed from these values:
  #   - Undirected graph: {mode}_graph_{name_suffix}    (e.g., "h3_graph_20")
  #   - Weighted graph: {mode}_graph_wt_{name_suffix}   (e.g., "h3_graph_wt_20")
  mode: "fine"                      # Options: "fine" (regular grid) or "h3" (hexagonal)
  name_suffix: "pg_10_v2"               # Suffix for graph table/file names

  # Route buffer configuration
  load_base_route: true           # Load pre-computed base route from step 1
  buffer_size_nm: 24.0            # Buffer distance around route (NM)

  # Optional area slicing (for testing/optimization/reducing memory usage)
  # Set slice_buffer=true to restrict processing to a specific geographic region
  # Useful for: memory-constrained systems, testing, or regional analysis
  slice_buffer: true
  slice_south_degree: 37.0        # Southern latitude limit (if slice_buffer=true)
  slice_north_degree: 38.0        # Northern latitude limit (if slice_buffer=true)
  slice_west_degree: -123.5       # Western longitude limit (if slice_buffer=true) - negative = West
  slice_east_degree: -122.0       # Eastern longitude limit (if slice_buffer=true) - negative = West

  # Fine grid specific parameters (when mode: "fine")
  # Regular rectangular grid for high-precision routing
  fine_spacing_nm: 0.1            # Node spacing in NM (smaller = denser graph)
  fine_max_edge_factor: 3.0       # Max edge length multiplier
  fine_bridge_components: true    # Bridge disconnected components

  # H3 hexagonal grid parameters inherited from graph_config.yml
  # See src/nautical_graph_toolkit/data/graph_config.yml for h3_settings

  # Port definitions for route calculation on fine graph
  # These are the actual routing start/end points (may differ from base_graph ports)
  departure_port: "Pilot"
  departure_coords: {lon: -122.27, lat: 37.0}  # Custom pilot boarding point (not WPI)
  arrival_port: "San Francisco"
  arrival_coords: null            # null = use World Port Index coordinates for SF

  # Save options for fine/H3 graph
  save_gpkg: true                 # Save to GeoPackage (fastest, portable)
  save_postgis: false             # Save to PostGIS (standard insert)
  save_postgis_optimized: true    # Save to PostGIS (optimized bulk insert) - needed for weighting
  postgis_chunk_size: 500000      # Batch size for optimized inserts
  drop_existing: true             # Replace existing tables

# ===============================================
# STEP 3: WEIGHTING CONFIGURATION
# ===============================================
# Apply three-tier weighting system:
# - Static weights: Distance-based penalties from features
# - Directional weights: Traffic flow alignment
# - Dynamic weights: Vessel-specific constraints

weighting:
  # Graph table naming
  # IMPORTANT: Graph names are automatically constructed from fine_graph configuration:
  #   - Source (undirected): {fine_graph.mode}_graph_{fine_graph.name_suffix}
  #   - Target (directed): {fine_graph.mode}_graph_wt_{fine_graph.name_suffix}
  # Example with fine_graph.mode="h3" and fine_graph.name_suffix="20":
  #   - source_graph_undirected = "h3_graph_20"
  #   - target_graph_directed = "h3_graph_wt_20"
  # You do NOT need to manually set these values; they are auto-generated by the workflow.

  # Sub-step control (can skip completed steps)
  steps:
    convert_to_directed: true     # Convert undirected → directed graph
    enrich_features: true         # Add S-57 feature attributes to edges
    apply_static_weights: true    # Distance-based feature weights
    apply_directional_weights: true  # Traffic flow alignment weights
    apply_dynamic_weights: true   # Vessel-specific constraint weights

  # Vessel parameters (override defaults from graph_config.yml)
  # These constraints determine navigable water depth and clearance requirements
  vessel:
    draft: 7.5                    # Depth of hull below waterline (meters)
    height: 30.0                  # Height above waterline / air draft (meters)
    safety_margin: 2.0            # Additional under-keel clearance buffer (meters)
    vessel_type: "cargo"          # Vessel classification for feature weighting

  # Environmental conditions
  environment:
    weather_factor: 1.2           # 1.0=good, >1.0=poor (weight multiplier)
    visibility_factor: 1.1        # 1.0=good, >1.0=poor (weight multiplier)
    time_of_day: "day"            # "day" or "night"

  # Feature enrichment configuration
  enrichment:
    include_sources: false        # Store ENC source chart names in edge attributes
    soundg_buffer_meters: 30      # Radius for sounding (depth) point spatial queries (meters)

  # Static weights usage bands
  # Determines which ENC chart scales contribute to weighting:
  #   Band 3: Approach charts (1:90,000 scale)
  #   Band 4: Coastal/Harbour charts (1:22K-45K scale)
  #   Band 5: Berthing charts (1:4K-12K scale)
  # TIP: Include higher bands for more detailed feature weighting
  static_weights_usage_bands: [3, 4, 5]

# ===============================================
# STEP 4: PATHFINDING CONFIGURATION
# ===============================================
# Calculate optimal routes on weighted graph

pathfinding:
  # Graph table naming
  # Routes are calculated on the weighted graph automatically named:
  #   {fine_graph.mode}_graph_wt_{fine_graph.name_suffix}
  # Example: h3_graph_wt_20 (derived from fine_graph.mode="h3", fine_graph.name_suffix="20")

  # Port definitions for route calculation (final routing endpoints)
  # These may differ from fine_graph ports if different start/end points are desired
  departure_port: "SF Pilot"
  departure_coords: {lon: -122.780, lat: 37.006}  # Pilot boarding area (customizable)
  arrival_port: "San Francisco Arrival"
  arrival_coords: {lon: -122.400, lat: 37.805}    # Destination port (customizable)

  # Weight key for routing (must match output from weighting step)
  # Use "adjusted_weight" for final weighted routes (includes all three weight tiers)
  weight_key: "adjusted_weight"

  # Export options
  export_weighted_graph: true     # Save final weighted graph to GeoPackage file
  route_filename_template: "detailed_route_{draft}m_draft.geojson"  # Template for output filename

# ===============================================
# OUTPUT CONFIGURATION
# ===============================================

output:
  # Base output directories (created automatically if they don't exist)
  base_dir: "output"      # Where GeoPackage files and routes are saved
  log_dir: "docs/logs"    # Where workflow logs and debug files are saved

  # Performance benchmark CSV export (optional)
  benchmarks:
    enabled: true                 # Save performance metrics to CSV files
    base_graph_file: "benchmark_graph_base.csv"        # Base graph timing stats
    fine_graph_file: "benchmark_graph_fine.csv"        # Fine/H3 graph timing stats
    weighted_graph_file: "benchmark_graph_weighted_directed.csv"  # Weighting timing stats

# ===============================================
# LOGGING CONFIGURATION
# ===============================================

logging:
  console_level: "INFO"           # Console output: INFO (normal), DEBUG (verbose), WARNING (minimal)
  file_level: "DEBUG"             # Log file always captures DEBUG level for troubleshooting
  progress_bars: true             # Show tqdm progress bars for long-running operations

# ===============================================
# QUICK REFERENCE FOR END USERS
# ===============================================
#
# SETUP CHECKLIST:
# 1. Create .env file in project root with database credentials
# 2. Ensure S-57 ENC data is loaded in the database
# 3. Review graph_config.yml for H3 resolution settings
# 4. Adjust vessel parameters (draft, height) for your vessel
# 5. Set departure/arrival ports and coordinates for your route
#
# NAMING CONVENTIONS (auto-generated, do not modify):
# - Base graph: {base_graph.graph_name}.gpkg (e.g., base_graph.gpkg)
# - Base route: {base_graph.base_route_name} (e.g., base_route)
# - Fine undirected: {fine_graph.mode}_graph_{fine_graph.name_suffix} (e.g., h3_graph_20)
# - Fine weighted: {fine_graph.mode}_graph_wt_{fine_graph.name_suffix} (e.g., h3_graph_wt_20)
# NOTE: Only modify base_graph.graph_name, base_graph.base_route_name, fine_graph.mode,
#       and fine_graph.name_suffix to customize naming. Other naming fields are auto-generated.
#
# WORKFLOW EXECUTION ORDER (do not skip steps):
# 1. base_graph: Creates initial coarse graph and baseline route
# 2. fine_graph: Creates high-resolution graph from base route buffer
# 3. weighting: Applies feature-based penalties and traffic patterns
# 4. pathfinding: Calculates final optimized route on weighted graph
#
# COMMON ISSUES:
# - Table not found: Verify fine_graph.mode and fine_graph.name_suffix are set correctly
#   (auto-generated table names depend on these values)
# - Coordinates out of bounds: Check longitude (negative = West), latitude ranges
# - Memory errors: Reduce fine_spacing_nm, reduce buffer_size_nm, or enable slice_buffer
#   (slice_buffer restricts area with: slice_south/north_degree, slice_west/east_degree)
# - Slow performance: Increase spacing_nm, disable unused weighting steps
#
# OUTPUT FILES:
# - GeoPackage files: {base_dir}/{mode}_graph_{suffix}.gpkg (e.g., h3_graph_20.gpkg)
# - Routes (GeoJSON): {base_dir}/detailed_route_{draft}m_draft.geojson
# - Logs: {log_dir}/*.log
# - Benchmarks (CSV): {base_dir}/benchmark_*.csv
